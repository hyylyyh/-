# 战斗体系需求说明

本文件描述战斗系统的需求与规则，不包含任何代码与实现细节。

## 目标
- 支持文本 RPG 的回合制战斗流程。
- 兼容事件系统的战斗事件触发、结算与日志记录。
- 具备可扩展的技能、状态、敌人配置能力。

## 核心流程
- 战斗触发：当事件类型为战斗或事件配置包含敌群 ID 时进入战斗。
- 先手判定：
  - 默认使用速度值判定先手；同速时随机。
  - 支持强制先手规则：玩家先手 / 敌人先手 / 随机。
- 回合执行：
  - 每回合按先手顺序行动。
  - 回合开始处理控制/减速等状态效果。
  - 行动后处理持续伤害、状态衰减。
- 回合上限：
  - 若事件配置回合上限，达到上限未击败敌人则判定失败。
- 结算：
  - 胜利：应用事件奖励、掉落与经验。
  - 失败：保留部分资源并继续流程（不得强制结束整局）。

## 伤害与命中规则
- 伤害公式：
  - 基础伤害 = 攻击力 - 防御力（最低为 1）。
  - 最终伤害 = 基础伤害 × 伤害倍率 × 暴击倍率（向下取整，最低为 1）。
- 命中/闪避：
  - 命中率 = 命中 / (命中 + 闪避)，最低 20%，最高 95%。
- 暴击：
  - 暴击率受暴击值与抗暴影响。
  - 暴击伤害倍率默认 150%，可扩展。

## 状态体系
- 需要支持的状态类型：
  - 中毒、流血、眩晕、护盾、加速、减速。
- 状态行为：
  - 中毒/流血：回合结束结算持续伤害。
  - 眩晕：回合开始跳过行动。
  - 护盾：降低受到的伤害，支持叠层。
  - 加速/减速：影响先手判定速度。
- 状态规则：
  - 支持持续回合数、叠加层数与强度。
  - 状态需在回合结束时衰减并移除过期层。

## 敌人体系
- 敌人类型：普通/精英/首领。
- 敌人属性：生命、攻击、防御、速度、命中、闪避、暴击、暴击伤害、抗暴。
- 敌群配置：
  - 允许敌群包含多个同类敌人。
  - 群怪战需按数量调整敌人生命/攻击/防御/速度的缩放系数。

## 事件与战斗衔接
- 事件字段支持：
  - 敌群 ID、回合上限、先手规则、战斗倍率（敌人生命/伤害）。
- 战斗日志要求：
  - 记录回合开始、命中/暴击判定、伤害结算、状态触发与最终结果。
  - 日志需可在 UI 中展示并支持回放。

## 奖励与掉落
- 胜利后应用事件结果：HP/MP 变化、金币、经验、掉落表。
- 失败处理：
  - 不可清空角色资源；至少保留部分资源。
- 掉落机制：
  - 支持事件配置掉落表与保底次数。

## 可扩展性要求
- 技能系统：支持主动/被动技能，包含消耗、冷却、目标类型与效果配置。
- 数值平衡：
  - 普通怪平均 3~5 回合击败。
  - 首领战有机制压力但可胜。
- 可复现随机：
  - 战斗结果需支持固定随机种子复现。

## 日志与调试
- 关键流程必须有详细日志打印：
  - 战斗触发、先手判定、每回合行动、命中/暴击判定、伤害结算、状态变化、战斗结果。
- 日志内容需清晰、可读，并适合 UI 展示与测试回放。

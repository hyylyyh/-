# 关卡系统设计说明

## 目标
关卡系统用于驱动文本 RPG 的闯关流程，负责关卡生成、节点推进、事件触发、奖励结算与日志记录，支持无尽模式与可配置关卡数量。

## 核心原则
- 无尽模式：关卡可循环或动态生成，支持难度递增。
- 可配置：关卡/节点/事件均可通过 JSON 配置扩展。
- 可复现：支持固定随机种子以便测试与回放。
- 可追溯：完整记录路径、事件结果与奖励日志。

## 结构概览
- Stage（关卡实例）：由多个 Node（节点）组成，包含入口与出口。
- Node（节点）：进入即触发事件或提供选项，支持多分支。
- Event（事件）：战斗、陷阱、商店、宝箱、隐藏路径等。
- Option（选项）：事件内的可选操作，决定结果与后续节点。
- Reward（奖励）：金币、材料、装备、经验等。

## 数据模型（核心字段）
- Stage
  - id：关卡唯一 ID
  - name：关卡名称
  - difficulty：难度等级
  - floorIndex：层级/轮次
  - nodes：节点列表
  - entryNodeId / exitNodeId：入口/出口
- Node
  - id：节点 ID
  - type：节点类型（EVENT/BATTLE/SHOP/TRAP/REST）
  - neighbors：相邻节点 ID
  - visited：是否已访问
  - eventId：绑定事件 ID
  - conditions：进入条件
- Event
  - id：事件 ID
  - type：事件类型
  - description：事件文本
  - options：可选项列表
  - onceOnly：是否只触发一次
  - weight：权重（随机表使用）
- Option
  - id：选项 ID
  - text：选项文本
  - conditions：可用条件
  - effects：结算效果
  - nextNodeId：跳转节点
- Reward
  - gold / exp / items / materials：奖励内容

## 流程与状态机
1. startGame：初始化玩家、关卡、随机种子。
2. enterNode：进入节点，触发事件。
3. resolveOption：选择选项并结算效果。
4. advance：进入下一节点或结束关卡。
5. loop：无尽模式下生成下一关卡并持续推进。

## 事件类型与触发方式
- 战斗：进入即触发或选项触发。
- 陷阱：进入即触发，可能有反制选项。
- 宝箱：进入后提供开启/放弃等选项。
- 商店：进入后展示买卖选项。
- 隐藏路径：满足条件或概率触发。

## 关卡生成策略
- 固定关卡：按章节模板生成（新手教学/剧情节点）。
- 随机关卡：按难度权重表抽取事件与节点。
- 难度递增：随关卡数提升敌人强度与奖励期望。

## 日志与回放
- 记录路径：节点进入顺序、分支选择。
- 记录事件：事件结果、奖励、战斗摘要。
- 支持导出：用于测试回放与数值校验。

## 可配置数据（示例字段）
- stages.json
  - stages[]: id, name, difficulty, floors, nodes[], entry, exit
- nodes.json
  - nodes[]: id, type, neighbors[], eventId, conditions
- events.json
  - events[]: id, type, desc, options[], weight, onceOnly

## 与主循环/引擎的接口
- startGame(playerId, stageId)
- enterNode(nodeId)
- resolveOption(optionId)
- advance()
- getSnapshot()

## 测试要点
- 节点图连通性与无死路校验
- 事件权重抽取分布
- 失败惩罚与资源保留规则
- 固定种子下的可复现实例流程
